<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Minecraft è©èªæŒ–ç¤¦</title>
  <script src="https://html2canvas.hertzen.com/dist/html2canvas.min.js"></script>
  <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;700;900&family=VT323&display=swap" rel="stylesheet">
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: 'Noto Sans TC', sans-serif;
      min-height: 100vh;
      display: flex;
      justify-content: center;
      align-items: center;
      overflow-x: hidden;
      position: relative;
    }

    .gradient-bg {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: linear-gradient(180deg, 
        #87CEEB 0%, #7EC8E3 40%, #5BA3C6 70%, #3D8B6F 85%, #2D6B4F 100%
      );
      z-index: -3;
    }

    .background-blocks {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      pointer-events: none;
      z-index: -2;
      overflow: hidden;
    }

    .floating-block {
      position: absolute;
      width: 40px;
      height: 40px;
      opacity: 0.5;
      animation: floatBlock 8s ease-in-out infinite;
    }

    .floating-block.dirt {
      background: linear-gradient(135deg, #8B6914 0%, #5A3D08 100%);
      border: 2px solid #4A2D05;
    }

    .floating-block.stone {
      background: linear-gradient(135deg, #9A9A9A 0%, #5A5A5A 100%);
      border: 2px solid #3A3A3A;
    }

    .floating-block.grass {
      background: linear-gradient(180deg, #7CFC00 0%, #5D8A00 30%, #8B6914 30%, #6B4E0A 100%);
      border: 2px solid #4A2D05;
    }

    @keyframes floatBlock {
      0%, 100% { transform: translateY(0) rotate(0deg); }
      50% { transform: translateY(-20px) rotate(5deg); }
    }

    .game-wrapper {
      background: rgba(0, 0, 0, 0.85);
      border: 8px solid #4a4a4a;
      border-top-color: #6a6a6a;
      border-left-color: #6a6a6a;
      padding: 25px;
      max-width: 850px;
      width: 95%;
      box-shadow: inset 0 0 0 4px #2a2a2a, 0 10px 40px rgba(0,0,0,0.5);
    }

    h1 {
      font-family: 'VT323', monospace;
      color: #55FF55;
      text-align: center;
      font-size: 2.2rem;
      text-shadow: 4px 4px 0px #003300, 0 0 20px #55FF55;
      margin-bottom: 15px;
    }

    /* ç™»å…¥é¢æ¿ */
    .login-panel {
      text-align: center;
      padding: 20px;
    }

    .login-panel h2 {
      font-family: 'VT323', monospace;
      color: #FFD700;
      font-size: 2rem;
      margin-bottom: 20px;
      text-shadow: 3px 3px 0 #8B6914;
    }

    .login-form {
      max-width: 300px;
      margin: 0 auto;
    }

    .form-group {
      margin-bottom: 15px;
      text-align: left;
    }

    .form-group label {
      display: block;
      font-family: 'VT323', monospace;
      color: #aaa;
      font-size: 1.2rem;
      margin-bottom: 5px;
    }

    .form-input {
      width: 100%;
      padding: 12px;
      font-family: 'Noto Sans TC', sans-serif;
      font-size: 1.2rem;
      background: #1a1a1a;
      border: 4px solid;
      border-color: #0a0a0a #3a3a3a #3a3a3a #0a0a0a;
      color: white;
      outline: none;
    }

    .form-input:focus {
      border-color: #55FF55;
    }

    .login-btn {
      width: 100%;
      margin-top: 10px;
    }

    .login-error {
      color: #FF5555;
      font-family: 'VT323', monospace;
      font-size: 1.1rem;
      margin-top: 10px;
      display: none;
    }

    .login-error.show {
      display: block;
    }

    .login-loading {
      color: #FFFF55;
      font-family: 'VT323', monospace;
      font-size: 1.1rem;
      margin-top: 10px;
      display: none;
    }

    .login-loading.show {
      display: block;
    }

    /* ç©å®¶è³‡è¨Šåˆ— */
    .player-bar {
      display: flex;
      justify-content: space-between;
      align-items: center;
      background: rgba(0,0,0,0.5);
      padding: 8px 12px;
      margin-bottom: 10px;
      border: 3px solid #444;
    }

    .player-info-display {
      font-family: 'VT323', monospace;
      color: #FFD700;
      font-size: 1.1rem;
    }

    .player-actions {
      display: flex;
      gap: 8px;
    }

    .small-btn {
      font-family: 'VT323', monospace;
      font-size: 0.9rem;
      padding: 5px 10px;
      border: 3px solid;
      cursor: pointer;
    }

    .save-btn {
      border-color: #55FF55 #227722 #227722 #55FF55;
      background: linear-gradient(180deg, #44aa44 0%, #228822 100%);
      color: white;
    }

    .logout-btn {
      border-color: #FF5555 #772222 #772222 #FF5555;
      background: linear-gradient(180deg, #aa4444 0%, #882222 100%);
      color: white;
    }

    .status-bar {
      display: flex;
      justify-content: space-between;
      align-items: center;
      flex-wrap: wrap;
      gap: 10px;
      margin-bottom: 15px;
      padding: 12px;
      background: rgba(0,0,0,0.5);
      border: 4px solid #3a3a3a;
    }

    .stat-group {
      display: flex;
      align-items: center;
      gap: 12px;
      flex-wrap: wrap;
    }

    .stat-item {
      font-family: 'VT323', monospace;
      font-size: 1.3rem;
      color: white;
      display: flex;
      align-items: center;
      gap: 4px;
    }

    .level-badge {
      background: linear-gradient(180deg, #FFD700 0%, #FFA500 100%);
      color: #000;
      padding: 4px 12px;
      font-family: 'VT323', monospace;
      font-size: 1.2rem;
      border: 3px solid #8B6914;
      font-weight: bold;
    }

    .hearts-container {
      display: flex;
      gap: 3px;
    }

    .heart {
      font-size: 1.5rem;
      filter: drop-shadow(0 0 3px #ff0000);
      transition: all 0.3s;
    }

    .heart.empty {
      opacity: 0.3;
      filter: grayscale(100%);
    }

    .heart.losing {
      animation: heartBreak 0.5s ease;
    }

    @keyframes heartBreak {
      0% { transform: scale(1); }
      50% { transform: scale(1.3); filter: brightness(2); }
      100% { transform: scale(0.8); opacity: 0.3; filter: grayscale(100%); }
    }

    .xp-container {
      margin-bottom: 15px;
    }

    .xp-bar-bg {
      background: #1a1a1a;
      border: 4px solid #0a0a0a;
      height: 25px;
      position: relative;
    }

    .xp-bar {
      height: 100%;
      background: linear-gradient(180deg, #7dff7d 0%, #44aa44 50%, #338833 100%);
      transition: width 0.5s ease;
    }

    .xp-text {
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      font-family: 'VT323', monospace;
      font-size: 1rem;
      color: white;
      text-shadow: 2px 2px 0 #000;
    }

    .question-area {
      text-align: center;
      margin-bottom: 20px;
    }

    .question-label {
      font-family: 'VT323', monospace;
      color: #aaaaaa;
      font-size: 1.1rem;
      margin-bottom: 8px;
    }

    .question-word {
      font-size: 3rem;
      font-weight: 900;
      color: #FFFF55;
      text-shadow: 4px 4px 0px #8B8B00;
      padding: 15px 25px;
      background: rgba(0,0,0,0.3);
      border: 4px solid #555;
      display: inline-block;
      min-width: 180px;
      animation: float 3s ease-in-out infinite;
      -webkit-user-select: none;
      user-select: none;
      pointer-events: none;
    }

    @keyframes float {
      0%, 100% { transform: translateY(0); }
      50% { transform: translateY(-8px); }
    }

    .input-area {
      display: flex;
      gap: 8px;
      justify-content: center;
      flex-wrap: wrap;
      margin-bottom: 15px;
    }

    .mc-input {
      font-family: 'Noto Sans TC', sans-serif;
      font-size: 1.4rem;
      padding: 10px 18px;
      width: 260px;
      background: #1a1a1a;
      border: 4px solid;
      border-color: #0a0a0a #3a3a3a #3a3a3a #0a0a0a;
      color: white;
      text-align: center;
      outline: none;
    }

    .mc-input:focus {
      border-color: #55FF55;
      box-shadow: 0 0 15px rgba(85, 255, 85, 0.3);
    }

    .mc-input.correct {
      border-color: #55FF55;
      animation: correctPulse 0.5s ease;
    }

    .mc-input.wrong {
      border-color: #FF5555;
      animation: wrongShake 0.5s ease;
    }

    @keyframes correctPulse {
      0%, 100% { transform: scale(1); }
      50% { transform: scale(1.03); }
    }

    @keyframes wrongShake {
      0%, 100% { transform: translateX(0); }
      25% { transform: translateX(-8px); }
      75% { transform: translateX(8px); }
    }

    .mc-btn {
      font-family: 'VT323', monospace;
      font-size: 1.2rem;
      padding: 10px 20px;
      border: 4px solid;
      border-color: #8b8b8b #373737 #373737 #8b8b8b;
      background: linear-gradient(180deg, #7a7a7a 0%, #4a4a4a 50%, #3a3a3a 100%);
      color: white;
      cursor: pointer;
      text-shadow: 2px 2px 0 #2a2a2a;
      transition: all 0.1s;
    }

    .mc-btn:hover {
      background: linear-gradient(180deg, #8a8a8a 0%, #5a5a5a 50%, #4a4a4a 100%);
    }

    .mc-btn:active {
      border-color: #373737 #8b8b8b #8b8b8b #373737;
      transform: translateY(2px);
    }

    .mc-btn.primary {
      border-color: #6daa3c #2d5a1c #2d5a1c #6daa3c;
      background: linear-gradient(180deg, #5d9a2c 0%, #3d7a0c 50%, #2d6a00 100%);
    }

    .mc-btn.skip-btn {
      border-color: #b8860b #6b4e0a #6b4e0a #b8860b;
      background: linear-gradient(180deg, #d4a017 0%, #9a7209 50%, #7c5c07 100%);
    }

    .mc-btn:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }

    .stats-row {
      display: flex;
      justify-content: center;
      gap: 20px;
      margin-bottom: 15px;
      flex-wrap: wrap;
    }

    .stat-box {
      text-align: center;
      padding: 8px 16px;
      background: rgba(0,0,0,0.4);
      border: 3px solid #444;
    }

    .stat-box .label {
      font-family: 'VT323', monospace;
      color: #888;
      font-size: 0.9rem;
    }

    .stat-box .value {
      font-family: 'VT323', monospace;
      color: #fff;
      font-size: 1.5rem;
    }

    .stat-box .value.correct { color: #55FF55; }
    .stat-box .value.wrong { color: #FF5555; }
    .stat-box .value.skipped { color: #FFAA00; }

    .combo-display {
      position: fixed;
      top: 50%;
      right: 20px;
      transform: translateY(-50%);
      font-family: 'VT323', monospace;
      font-size: 2.5rem;
      color: #FF5555;
      text-shadow: 0 0 20px #FF5555;
      display: none;
      z-index: 50;
    }

    .combo-display.active {
      display: block;
      animation: comboFloat 0.5s ease;
    }

    @keyframes comboFloat {
      0% { transform: translateY(-50%) scale(0.5); opacity: 0; }
      100% { transform: translateY(-50%) scale(1); opacity: 1; }
    }

    .rewards-preview {
      display: flex;
      justify-content: center;
      gap: 8px;
      margin-bottom: 15px;
      flex-wrap: wrap;
    }

    .reward-item {
      text-align: center;
      padding: 6px 10px;
      background: rgba(0,0,0,0.5);
      border: 3px solid #333;
      opacity: 0.5;
      transition: all 0.3s;
      min-width: 55px;
      cursor: pointer;
    }

    .reward-item.unlocked {
      opacity: 1;
      border-color: #FFD700;
      box-shadow: 0 0 10px rgba(255, 215, 0, 0.5);
    }

    .reward-item.unlocked:hover {
      transform: scale(1.1);
      box-shadow: 0 0 20px rgba(255, 215, 0, 0.8);
    }

    .reward-item.current {
      border-color: #55FF55;
      animation: currentReward 1s ease-in-out infinite;
    }

    @keyframes currentReward {
      0%, 100% { box-shadow: 0 0 5px #55FF55; }
      50% { box-shadow: 0 0 15px #55FF55; }
    }

    .reward-item .icon {
      font-size: 1.5rem;
      display: block;
    }

    .reward-item .req {
      font-family: 'VT323', monospace;
      font-size: 0.8rem;
      color: #aaa;
    }

    .progress-section {
      margin-top: 15px;
    }

    .progress-bar-container {
      background: #1a1a1a;
      border: 3px solid #0a0a0a;
      height: 18px;
      position: relative;
      margin-top: 8px;
    }

    .progress-bar-fill {
      height: 100%;
      background: linear-gradient(180deg, #55FF55 0%, #228822 50%, #116611 100%);
      transition: width 0.3s ease;
    }

    .progress-label {
      font-family: 'VT323', monospace;
      color: #888;
      font-size: 1rem;
      display: flex;
      justify-content: space-between;
    }

    .next-btn {
      display: none;
    }

    .next-btn.visible {
      display: inline-block;
    }

    .panel {
      display: none;
    }

    .panel.active {
      display: block;
    }

    .game-over-panel.active {
      display: block;
      text-align: center;
    }

    .result-title {
      font-family: 'VT323', monospace;
      font-size: 2.5rem;
      color: #55FF55;
      text-shadow: 4px 4px 0 #003300;
      margin-bottom: 20px;
    }

    .result-title.fail {
      color: #FF5555;
      text-shadow: 4px 4px 0 #330000;
    }

    .result-stats {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
      gap: 12px;
      margin-bottom: 25px;
    }

    .result-stat {
      background: rgba(0,0,0,0.5);
      padding: 12px;
      border: 3px solid #444;
    }

    .result-stat .label {
      font-family: 'VT323', monospace;
      color: #888;
      font-size: 0.9rem;
    }

    .result-stat .value {
      font-family: 'VT323', monospace;
      font-size: 1.6rem;
      color: #FFD700;
    }

    .unlocked-rewards {
      margin: 20px 0;
      padding: 15px;
      background: rgba(0,0,0,0.5);
      border: 3px solid #FFD700;
    }

    .unlocked-rewards h3 {
      font-family: 'VT323', monospace;
      color: #FFD700;
      font-size: 1.5rem;
      margin-bottom: 10px;
    }

    .reward-buttons {
      display: flex;
      gap: 10px;
      justify-content: center;
      flex-wrap: wrap;
    }

    .particle {
      position: fixed;
      pointer-events: none;
      font-size: 1.5rem;
      animation: particleFly 1s ease-out forwards;
      z-index: 100;
    }

    @keyframes particleFly {
      0% { opacity: 1; transform: translateY(0) scale(1); }
      100% { opacity: 0; transform: translateY(-80px) scale(0.5); }
    }

    .toast {
      position: fixed;
      bottom: 20px;
      left: 50%;
      transform: translateX(-50%);
      background: rgba(0,0,0,0.9);
      color: #55FF55;
      padding: 12px 25px;
      border: 4px solid #55FF55;
      font-family: 'VT323', monospace;
      font-size: 1.2rem;
      z-index: 100;
      animation: toastSlide 0.3s ease;
    }

    @keyframes toastSlide {
      0% { transform: translateX(-50%) translateY(50px); opacity: 0; }
      100% { transform: translateX(-50%) translateY(0); opacity: 1; }
    }

    .fullscreen-btn {
      position: fixed;
      top: 10px;
      right: 10px;
      background: rgba(0,0,0,0.7);
      border: 3px solid #55FF55;
      color: #55FF55;
      width: 40px;
      height: 40px;
      font-size: 1.2rem;
      cursor: pointer;
      z-index: 50;
    }

    .shop-panel {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0,0,0,0.8);
      z-index: 200;
      justify-content: center;
      align-items: center;
    }

    .shop-panel.active {
      display: flex;
    }

    .shop-content {
      background: #2a2a2a;
      border: 8px solid #4a4a4a;
      padding: 25px;
      text-align: center;
      max-width: 350px;
    }

    .shop-title {
      font-family: 'VT323', monospace;
      font-size: 1.8rem;
      color: #FFD700;
      margin-bottom: 15px;
    }

    .shop-item {
      background: rgba(0,0,0,0.5);
      padding: 15px;
      margin-bottom: 12px;
      border: 3px solid #444;
    }

    .shop-buttons {
      display: flex;
      gap: 8px;
      justify-content: center;
    }

    .reward-card-panel {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0,0,0,0.92);
      z-index: 300;
      justify-content: center;
      align-items: center;
      padding: 20px;
      overflow-y: auto;
    }

    .reward-card-panel.active {
      display: flex;
      animation: panelFadeIn 0.5s ease;
    }

    @keyframes panelFadeIn {
      0% { opacity: 0; }
      100% { opacity: 1; }
    }

    .reward-card-wrapper {
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 20px;
      animation: cardSlideIn 0.6s ease;
    }

    @keyframes cardSlideIn {
      0% { transform: scale(0.5) translateY(-50px); opacity: 0; }
      100% { transform: scale(1) translateY(0); opacity: 1; }
    }

    .unlock-celebration {
      text-align: center;
      margin-bottom: 10px;
    }

    .unlock-celebration h2 {
      font-family: 'VT323', monospace;
      font-size: 2rem;
      color: #FFD700;
      text-shadow: 0 0 20px #FFD700;
      animation: celebratePulse 0.5s ease infinite alternate;
    }

    @keyframes celebratePulse {
      0% { transform: scale(1); }
      100% { transform: scale(1.05); }
    }

    .reward-card {
      width: 380px;
      background: linear-gradient(180deg, #2d5016 0%, #1a3009 100%);
      border: 8px solid #8B6914;
      border-radius: 8px;
      padding: 20px;
      position: relative;
      box-shadow: 
        inset 0 0 0 4px #4a7a1c,
        0 10px 30px rgba(0,0,0,0.5),
        0 0 50px rgba(255, 215, 0, 0.3);
    }

    .reward-card::before {
      content: '';
      position: absolute;
      top: 10px;
      left: 10px;
      right: 10px;
      bottom: 10px;
      border: 2px dashed rgba(255,255,255,0.2);
      pointer-events: none;
    }

    .card-header {
      text-align: center;
      margin-bottom: 10px;
    }

    .card-title {
      font-family: 'VT323', monospace;
      font-size: 1.6rem;
      color: #FFD700;
      text-shadow: 2px 2px 0 #8B6914;
    }

    .card-subtitle {
      font-family: 'VT323', monospace;
      font-size: 0.9rem;
      color: #aaa;
    }

    .character-display {
      width: 100%;
      height: 160px;
      display: flex;
      justify-content: center;
      align-items: center;
      margin-bottom: 10px;
      background: rgba(0,0,0,0.3);
      border: 3px solid #333;
      overflow: hidden;
    }

    .character-display svg {
      max-width: 140px;
      max-height: 140px;
      animation: characterBounce 2s ease-in-out infinite;
    }

    @keyframes characterBounce {
      0%, 100% { transform: translateY(0); }
      50% { transform: translateY(-8px); }
    }

    .player-info-card {
      background: rgba(0,0,0,0.4);
      padding: 10px;
      border: 3px solid #4a4a4a;
      margin-bottom: 10px;
    }

    .player-name-display {
      font-family: 'VT323', monospace;
      font-size: 1.4rem;
      color: #FFD700;
      text-align: center;
    }

    .score-info {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 8px;
      margin-bottom: 10px;
    }

    .score-item {
      background: rgba(0,0,0,0.3);
      padding: 8px;
      text-align: center;
      border: 2px solid #444;
    }

    .score-item .label {
      font-family: 'VT323', monospace;
      font-size: 0.85rem;
      color: #888;
    }

    .score-item .value {
      font-family: 'VT323', monospace;
      font-size: 1.3rem;
      color: #55FF55;
    }

    .card-footer {
      text-align: center;
      font-family: 'VT323', monospace;
      font-size: 0.85rem;
      color: #666;
      border-top: 2px solid #444;
      padding-top: 8px;
    }

    .card-actions {
      display: flex;
      gap: 10px;
      justify-content: center;
      flex-wrap: wrap;
    }

    .milestone-thumbs {
      display: flex;
      gap: 8px;
      justify-content: center;
      margin-top: 10px;
    }

    .milestone-thumb {
      width: 50px;
      height: 50px;
      background: rgba(0,0,0,0.5);
      border: 3px solid #333;
      display: flex;
      justify-content: center;
      align-items: center;
      font-size: 1.5rem;
      opacity: 0.4;
      cursor: pointer;
      transition: all 0.3s;
    }

    .milestone-thumb.unlocked {
      opacity: 1;
      border-color: #FFD700;
    }

    .milestone-thumb.unlocked:hover {
      transform: scale(1.15);
      box-shadow: 0 0 15px rgba(255, 215, 0, 0.6);
    }

    .milestone-thumb.active {
      border-color: #55FF55;
      box-shadow: 0 0 10px #55FF55;
    }

    .firework {
      position: fixed;
      pointer-events: none;
      font-size: 2rem;
      animation: fireworkBurst 1.5s ease-out forwards;
      z-index: 400;
    }

    @keyframes fireworkBurst {
      0% { opacity: 1; transform: scale(0.5); }
      50% { opacity: 1; transform: scale(1.5); }
      100% { opacity: 0; transform: scale(2) translateY(-50px); }
    }

    /* è‡ªå‹•å„²å­˜æŒ‡ç¤ºå™¨ */
    .auto-save-indicator {
      position: fixed;
      top: 10px;
      left: 10px;
      font-family: 'VT323', monospace;
      font-size: 1rem;
      color: #55FF55;
      background: rgba(0,0,0,0.7);
      padding: 5px 10px;
      border: 2px solid #55FF55;
      display: none;
      z-index: 50;
    }

    .auto-save-indicator.show {
      display: block;
      animation: saveFlash 1s ease;
    }

    @keyframes saveFlash {
      0% { opacity: 0; }
      50% { opacity: 1; }
      100% { opacity: 0; }
    }

    /* ç¹¼çºŒé€²åº¦æç¤º */
    .continue-prompt {
      background: rgba(0,0,0,0.5);
      padding: 15px;
      margin-top: 15px;
      border: 3px solid #FFD700;
      text-align: center;
    }

    .continue-prompt h3 {
      font-family: 'VT323', monospace;
      color: #FFD700;
      font-size: 1.3rem;
      margin-bottom: 10px;
    }

    .continue-prompt p {
      font-family: 'VT323', monospace;
      color: #aaa;
      font-size: 1rem;
      margin-bottom: 10px;
    }

    .continue-buttons {
      display: flex;
      gap: 10px;
      justify-content: center;
    }

    @media (max-width: 600px) {
      h1 { font-size: 1.6rem; }
      .question-word { font-size: 2rem; padding: 10px 15px; }
      .mc-input { width: 100%; font-size: 1.2rem; }
      .stat-item { font-size: 1rem; }
      .reward-card { width: 320px; padding: 15px; }
      .reward-card-panel { padding: 10px; }
      .reward-item { padding: 5px 8px; min-width: 45px; }
      .reward-item .icon { font-size: 1.2rem; }
      .reward-item .req { font-size: 0.7rem; }
      .milestone-thumb { width: 40px; height: 40px; font-size: 1.2rem; }
      .character-display { height: 130px; }
      .character-display svg { max-width: 110px; max-height: 110px; }
      .player-bar { flex-direction: column; gap: 8px; }
    }
  </style>
</head>
<body>
  <div class="gradient-bg"></div>
  <div class="background-blocks" id="bgBlocks"></div>
  <button class="fullscreen-btn" onclick="toggleFullscreen()">â›¶</button>
  <div class="auto-save-indicator" id="autoSaveIndicator">ğŸ’¾ å„²å­˜ä¸­...</div>

  <div class="game-wrapper">
    <!-- ç™»å…¥é¢æ¿ -->
    <div class="panel active" id="loginPanel">
      <h1>â›ï¸ Minecraft è©èªæŒ–ç¤¦ â›ï¸</h1>
      <div class="login-panel">
        <h2>ğŸ® ç¤¦å·¥ç™»å…¥</h2>
        <div class="login-form">
          <div class="form-group">
            <label>ğŸ‘¤ å§“åï¼ˆä¸­æ–‡ï¼‰</label>
            <input type="text" class="form-input" id="loginName" placeholder="è«‹è¼¸å…¥å§“å">
          </div>
          <div class="form-group">
            <label>ğŸ”‘ å¯†ç¢¼ï¼ˆå­¸è™Ÿï¼‰</label>
            <input type="password" class="form-input" id="loginPassword" placeholder="è«‹è¼¸å…¥å­¸è™Ÿ">
          </div>
          <button class="mc-btn primary login-btn" id="loginBtn" onclick="login()">â›ï¸ é–‹å§‹æŒ–ç¤¦</button>
          <div class="login-error" id="loginError"></div>
          <div class="login-loading" id="loginLoading">â³ ç™»å…¥ä¸­...</div>
        </div>

        <div class="continue-prompt" id="continuePrompt" style="display: none;">
          <h3>ğŸ“‚ ç™¼ç¾ä¸Šæ¬¡é€²åº¦</h3>
          <p id="continueInfo"></p>
          <div class="continue-buttons">
            <button class="mc-btn primary" onclick="continueProgress()">ç¹¼çºŒéŠæˆ²</button>
            <button class="mc-btn" onclick="startNew()">é‡æ–°é–‹å§‹</button>
          </div>
        </div>
      </div>
    </div>

    <!-- éŠæˆ²é¢æ¿ -->
    <div class="panel" id="gamePanel">
      <h1>â›ï¸ Minecraft è©èªæŒ–ç¤¦ â›ï¸</h1>

      <div class="player-bar">
        <div class="player-info-display">
          ğŸ‘¤ <span id="playerName">-</span> | ğŸ“š <span id="playerClass">-</span>
        </div>
        <div class="player-actions">
          <button class="small-btn save-btn" onclick="manualSave()">ğŸ’¾ å„²å­˜</button>
          <button class="small-btn logout-btn" onclick="logout()">ğŸšª ç™»å‡º</button>
        </div>
      </div>

      <div class="status-bar">
        <div class="stat-group">
          <div class="level-badge">ç­‰ç´š <span id="level">1</span></div>
          <div class="stat-item">ğŸ”¥ <span id="combo">0</span></div>
        </div>
        <div class="stat-group">
          <div class="stat-item">ğŸª <span id="cookies">5</span></div>
          <div class="stat-item">ğŸ’ <span id="diamonds">0</span></div>
          <div class="stat-item">â­ <span id="stars">0</span></div>
        </div>
        <div class="hearts-container" id="hearts">
          <span class="heart">â¤ï¸</span>
          <span class="heart">â¤ï¸</span>
          <span class="heart">â¤ï¸</span>
        </div>
      </div>

      <div class="rewards-preview">
        <div class="reward-item" id="reward10" onclick="viewReward('pig')">
          <span class="icon">ğŸ·</span>
          <span class="req">10é¡Œ</span>
        </div>
        <div class="reward-item" id="reward30" onclick="viewReward('cow')">
          <span class="icon">ğŸ„</span>
          <span class="req">30é¡Œ</span>
        </div>
        <div class="reward-item" id="reward60" onclick="viewReward('creeper')">
          <span class="icon">ğŸ’š</span>
          <span class="req">60é¡Œ</span>
        </div>
        <div class="reward-item" id="reward90" onclick="viewReward('wolf')">
          <span class="icon">ğŸº</span>
          <span class="req">90é¡Œ</span>
        </div>
        <div class="reward-item" id="reward100" onclick="viewReward('steve')">
          <span class="icon">â›ï¸</span>
          <span class="req">100é¡Œ</span>
        </div>
      </div>

      <div class="xp-container">
        <div class="xp-bar-bg">
          <div class="xp-bar" id="xpBar" style="width: 0%"></div>
          <div class="xp-text">XP: <span id="xpText">0</span></div>
        </div>
      </div>

      <div class="question-area">
        <div class="question-label">ç¬¬ <span id="questionNum">1</span> / <span id="totalQuestions">100</span> é¡Œ ï¼ˆç­”å°ï¼š<span id="correctDisplay">0</span> é¡Œï¼‰</div>
        <div class="question-word" id="questionWord">æº–å‚™é–‹å§‹</div>
      </div>

      <div class="input-area">
        <input type="text" class="mc-input" id="answerInput" placeholder="è¼¸å…¥è©èª..." autocomplete="off">
        <button class="mc-btn primary" id="submitBtn" onclick="submitAnswer()">â›ï¸ æŒ–æ˜</button>
        <button class="mc-btn skip-btn" onclick="openShop()">ğŸª è·³é</button>
        <button class="mc-btn primary next-btn" id="nextBtn" onclick="nextQuestion()">â¡ï¸ ä¸‹ä¸€é¡Œ</button>
      </div>

      <div class="stats-row">
        <div class="stat-box">
          <div class="label">æ­£ç¢º</div>
          <div class="value correct" id="correctCount">0</div>
        </div>
        <div class="stat-box">
          <div class="label">éŒ¯èª¤</div>
          <div class="value wrong" id="wrongCount">0</div>
        </div>
        <div class="stat-box">
          <div class="label">ç•¥é</div>
          <div class="value skipped" id="skippedCount">0</div>
        </div>
        <div class="stat-box">
          <div class="label">æ­£ç¢ºç‡</div>
          <div class="value" id="accuracy">0%</div>
        </div>
      </div>

      <div class="progress-section">
        <div class="progress-label">
          <span>ä¸‹å€‹é‡Œç¨‹ç¢‘</span>
          <span id="progressText">10 é¡Œ</span>
        </div>
        <div class="progress-bar-container">
          <div class="progress-bar-fill" id="progressBar" style="width: 0%"></div>
        </div>
      </div>
    </div>

    <!-- çµç®—é¢æ¿ -->
    <div class="panel game-over-panel" id="gameOverPanel">
      <h2 class="result-title" id="resultTitle">ğŸ‰ æŒ–ç¤¦å®Œæˆï¼</h2>
      <div class="result-stats">
        <div class="result-stat">
          <div class="label">ç­”å°é¡Œæ•¸</div>
          <div class="value" id="finalQuestions">0</div>
        </div>
        <div class="result-stat">
          <div class="label">æ­£ç¢ºç‡</div>
          <div class="value" id="finalAccuracy">0%</div>
        </div>
        <div class="result-stat">
          <div class="label">æœ€é«˜é€£æ“Š</div>
          <div class="value" id="finalCombo">0</div>
        </div>
        <div class="result-stat">
          <div class="label">ç¸½ç¶“é©—å€¼</div>
          <div class="value" id="finalXP">0</div>
        </div>
      </div>

      <div class="unlocked-rewards" id="unlockedRewards" style="display: none;">
        <h3>ğŸ† å·²æ”¶é›†çš„çå‹µ</h3>
        <div class="reward-buttons" id="rewardButtons"></div>
      </div>

      <div style="display: flex; gap: 10px; justify-content: center; margin-top: 15px; flex-wrap: wrap;">
        <button class="mc-btn primary" onclick="restartGame()">ğŸ”„ å†ç©ä¸€æ¬¡</button>
        <button class="mc-btn" onclick="logout()">ğŸšª ç™»å‡º</button>
      </div>
    </div>
  </div>

  <div class="combo-display" id="comboDisplay"></div>

  <div class="shop-panel" id="shopPanel">
    <div class="shop-content">
      <div class="shop-title">ğŸª ç¤¦å·¥å•†åº—</div>
      <div class="shop-item">
        <div style="font-family: 'VT323', monospace; font-size: 1.3rem; color: #fff;">â­ï¸ è·³éæ­¤é¡Œ</div>
        <div style="font-family: 'VT323', monospace; font-size: 1.1rem; color: #FFAA00; margin: 8px 0;">èŠ±è²»ï¼šğŸª Ã— 3</div>
        <div class="shop-buttons">
          <button class="mc-btn primary" onclick="useSkip()">ç¢ºèªè³¼è²·</button>
          <button class="mc-btn" onclick="closeShop()">å–æ¶ˆ</button>
        </div>
      </div>
      <p style="color: #888; margin-top: 12px; font-family: 'VT323', monospace;">
        ç›®å‰æ“æœ‰ï¼šğŸª Ã— <span id="shopCookies">5</span>
      </p>
    </div>
  </div>

  <div class="reward-card-panel" id="rewardCardPanel">
    <div class="reward-card-wrapper">
      <div class="unlock-celebration" id="unlockCelebration">
        <h2>ğŸ‰ æ­å–œè§£é–æ–°çå‹µï¼ğŸ‰</h2>
      </div>

      <div class="reward-card" id="rewardCard">
        <div class="card-header">
          <div class="card-title" id="cardTitle">ğŸ· è±¬è±¬æ”¶è—å¡</div>
          <div class="card-subtitle">Minecraft è©èªæŒ–ç¤¦æˆå°±</div>
        </div>

        <div class="character-display" id="characterDisplay"></div>

        <div class="player-info-card">
          <div class="player-name-display" id="cardPlayerName">ç¤¦å·¥åç¨±</div>
        </div>

        <div class="score-info">
          <div class="score-item">
            <div class="label">ç­”å°é¡Œæ•¸</div>
            <div class="value" id="cardQuestions">0</div>
          </div>
          <div class="score-item">
            <div class="label">æ­£ç¢ºç‡</div>
            <div class="value" id="cardAccuracy">0%</div>
          </div>
          <div class="score-item">
            <div class="label">æœ€é«˜é€£æ“Š</div>
            <div class="value" id="cardCombo">0</div>
          </div>
          <div class="score-item">
            <div class="label">ç¸½ç¶“é©—å€¼</div>
            <div class="value" id="cardXP">0</div>
          </div>
        </div>

        <div class="card-footer">
          ğŸ“… <span id="cardDate"></span> | Minecraft è©èªæŒ–ç¤¦
        </div>
      </div>

      <div class="milestone-thumbs" id="milestoneThumbs">
        <div class="milestone-thumb" data-type="pig" onclick="switchCardType('pig')">ğŸ·</div>
        <div class="milestone-thumb" data-type="cow" onclick="switchCardType('cow')">ğŸ„</div>
        <div class="milestone-thumb" data-type="creeper" onclick="switchCardType('creeper')">ğŸ’š</div>
        <div class="milestone-thumb" data-type="wolf" onclick="switchCardType('wolf')">ğŸº</div>
        <div class="milestone-thumb" data-type="steve" onclick="switchCardType('steve')">â›ï¸</div>
      </div>

      <div class="card-actions">
        <button class="mc-btn primary" onclick="downloadCard()">ğŸ“¥ å„²å­˜åœ–ç‰‡</button>
        <button class="mc-btn" onclick="closeRewardCard()">ç¹¼çºŒéŠæˆ²</button>
      </div>
    </div>
  </div>

  <script>
    // ============ Google Apps Script è¨­å®š ============
    // è«‹å°‡ä¸‹æ–¹ç¶²å€æ”¹æˆä½ éƒ¨ç½²çš„ Apps Script ç¶²å€
    const API_URL = 'https://script.google.com/macros/s/AKfycbxlwEAC_qy6oRjNbhY3PIjbqJKz50PuPJuOhj-JtGWP6Ok0DoDcgubgIk2Nku58Y333QQ/exec';
    
    // ============ è©åº« ============
    const twoCharWords = [
      "è¬¹æ…", "è¬™è™›", "æ•æ·", "çŒ¶è±«", "èª ä¿¡", "å‹¤å‹‰", "å …éŸŒ", "æº«é¦¨", "ç‡¦çˆ›", "æ†‚é¬±",
      "ç†±å¿±", "å†·æ¼ ", "å–„è‰¯", "é‚ªæƒ¡", "å‹‡æ•¢", "è†½æ€¯", "è°ç©", "æ„šæ˜§", "å„ªé›…", "ç²—é­¯",
      "å¯§éœ", "å–§é¬§", "ç¹è¯", "è•­æ¢", "æ­¡æ¬£", "å“€å‚·", "æ˜äº®", "é™°æš—", "ç”œèœœ", "è‹¦æ¾€",
      "è¼•ç›ˆ", "æ²‰é‡", "è¿…é€Ÿ", "ç·©æ…¢", "å¯¬å»£", "ç‹¹çª„", "é«˜è³", "ä½çŸ®", "å …å›º", "è„†å¼±",
      "è±å¯Œ", "è²§ä¹", "æ–°ç©", "é™³èˆŠ", "ç²¾ç·»", "ç²—ç³™", "æ¸…æ¾ˆ", "æ¸¾æ¿", "èŠ¬èŠ³", "æƒ¡è‡­"
    ];

    const threeCharWords = [
      "è—è¡“å®¶", "ç¢°é‹æ°£", "åˆ¤æ–·åŠ›", "å»¶é•·ç·š", "å®¶é„‰å‘³", "ç–Šç¾…æ¼¢", "ç¬‘å˜»å˜»", "éµæ¬„æ†", "åŸºé‡‘æœƒ", "é¬§å½†æ‰­",
      "å¤§å¯Œç¿", "å¹é¬å­", "ç™½å¸åŸ", "å¤§å°‡è»", "è€ç™¾å§“", "é å‘Šç‰‡", "ç´¡ç¹”æ¥­", "ç¶ ç¹¡çœ¼", "èŠ±åœƒè£¡", "å¤§è¥¿æ´‹",
      "å—ç¾æ´²", "å¤§ä¸ˆå¤«", "è’²å…¬è‹±", "é€£èº«è£™", "é»ƒæ¾„æ¾„", "ç¬‘å’ªå’ª", "é–’ç½®ä¸­", "æ•²é–€ç£š", "å°ç«ç·š", "è«é ˆæœ‰",
      "å‰¯ä½œç”¨", "åŒç†å¿ƒ", "é¬§æƒ…ç·’", "ç™¼è„¾æ°£", "é™°æ£®æ£®", "æ…˜å…®å…®", "æŒ«æŠ˜æ„Ÿ", "ç»ç’ƒå¿ƒ", "æ‚¶è‘«è˜†", "å®šå¿ƒä¸¸",
      "å…‰æ˜ç£Šè½", "ä¸–ç•Œéºç”¢", "å¼µç‰™èˆçˆª", "ç›®ä¸æš‡çµ¦", "é¬¼æ–§ç¥å·¥", "ç›®çœ©ç¥è¿·", "ä¸€æ“è€Œä¸Š", "åˆ¤æ–·åŠ›", "æ˜Ÿç¾…æ£‹å¸ƒ", "å…¨åŠ›ä»¥èµ´"
    ];

    const wordBank = [...twoCharWords, ...threeCharWords];

    // åƒç´ é¢¨æ ¼ SVG è§’è‰²
    const characterSVG = {
      pig: `<svg viewBox="0 0 64 64" xmlns="http://www.w3.org/2000/svg">
        <rect x="16" y="20" width="32" height="24" fill="#f5a0a0"/>
        <rect x="16" y="20" width="32" height="4" fill="#f5b8b8"/>
        <rect x="12" y="24" width="8" height="16" fill="#f5a0a0"/>
        <rect x="44" y="24" width="8" height="16" fill="#f5a0a0"/>
        <rect x="20" y="28" width="4" height="4" fill="#222"/>
        <rect x="36" y="28" width="4" height="4" fill="#222"/>
        <rect x="24" y="36" width="12" height="8" fill="#ffcccc"/>
        <rect x="28" y="38" width="2" height="4" fill="#996666"/>
        <rect x="34" y="38" width="2" height="4" fill="#996666"/>
        <rect x="8" y="20" width="6" height="6" fill="#f5a0a0"/>
        <rect x="50" y="20" width="6" height="6" fill="#f5a0a0"/>
        <rect x="16" y="44" width="6" height="12" fill="#f5a0a0"/>
        <rect x="26" y="44" width="6" height="12" fill="#f5a0a0"/>
        <rect x="32" y="44" width="6" height="12" fill="#f5a0a0"/>
        <rect x="42" y="44" width="6" height="12" fill="#f5a0a0"/>
        <path d="M52 32 Q58 34 54 38" stroke="#f5a0a0" stroke-width="3" fill="none"/>
      </svg>`,
      
      cow: `<svg viewBox="0 0 64 64" xmlns="http://www.w3.org/2000/svg">
        <rect x="14" y="22" width="36" height="26" fill="#d4d4d4"/>
        <rect x="20" y="28" width="10" height="12" fill="#3a3a3a"/>
        <rect x="34" y="24" width="8" height="10" fill="#3a3a3a"/>
        <rect x="10" y="26" width="10" height="14" fill="#d4d4d4"/>
        <rect x="18" y="30" width="4" height="4" fill="#222"/>
        <rect x="6" y="30" width="4" height="4" fill="#222"/>
        <rect x="8" y="38" width="12" height="6" fill="#f5c6a5"/>
        <rect x="4" y="18" width="4" height="10" fill="#f5f5dc"/>
        <rect x="18" y="18" width="4" height="10" fill="#f5f5dc"/>
        <rect x="0" y="24" width="6" height="6" fill="#d4d4d4"/>
        <rect x="20" y="24" width="6" height="6" fill="#d4d4d4"/>
        <rect x="14" y="48" width="6" height="12" fill="#d4d4d4"/>
        <rect x="14" y="56" width="6" height="4" fill="#3a3a3a"/>
        <rect x="24" y="48" width="6" height="12" fill="#d4d4d4"/>
        <rect x="24" y="56" width="6" height="4" fill="#3a3a3a"/>
        <rect x="34" y="48" width="6" height="12" fill="#d4d4d4"/>
        <rect x="34" y="56" width="6" height="4" fill="#3a3a3a"/>
        <rect x="44" y="48" width="6" height="12" fill="#d4d4d4"/>
        <rect x="44" y="56" width="6" height="4" fill="#3a3a3a"/>
      </svg>`,
      
      creeper: `<svg viewBox="0 0 64 64" xmlns="http://www.w3.org/2000/svg">
        <rect x="12" y="4" width="40" height="40" fill="#5fa55a"/>
        <rect x="12" y="4" width="40" height="6" fill="#6fb56a"/>
        <rect x="16" y="14" width="10" height="12" fill="#1a1a1a"/>
        <rect x="38" y="14" width="10" height="12" fill="#1a1a1a"/>
        <rect x="26" y="22" width="12" height="6" fill="#1a1a1a"/>
        <rect x="20" y="28" width="6" height="12" fill="#1a1a1a"/>
        <rect x="38" y="28" width="6" height="12" fill="#1a1a1a"/>
        <rect x="26" y="28" width="12" height="16" fill="#1a1a1a"/>
        <rect x="20" y="44" width="10" height="16" fill="#5fa55a"/>
        <rect x="34" y="44" width="10" height="16" fill="#5fa55a"/>
      </svg>`,
      
      wolf: `<svg viewBox="0 0 64 64" xmlns="http://www.w3.org/2000/svg">
        <rect x="16" y="24" width="32" height="20" fill="#c4c4c4"/>
        <rect x="16" y="24" width="32" height="4" fill="#d8d8d8"/>
        <rect x="8" y="16" width="16" height="20" fill="#c4c4c4"/>
        <rect x="8" y="16" width="16" height="4" fill="#d8d8d8"/>
        <rect x="4" y="8" width="6" height="10" fill="#c4c4c4"/>
        <rect x="18" y="8" width="6" height="10" fill="#c4c4c4"/>
        <rect x="10" y="22" width="4" height="4" fill="#222"/>
        <rect x="18" y="22" width="4" height="4" fill="#222"/>
        <rect x="12" y="30" width="8" height="4" fill="#444"/>
        <rect x="14" y="32" width="4" height="2" fill="#ff6666"/>
        <rect x="16" y="44" width="6" height="12" fill="#c4c4c4"/>
        <rect x="26" y="44" width="6" height="12" fill="#c4c4c4"/>
        <rect x="32" y="44" width="6" height="12" fill="#c4c4c4"/>
        <rect x="42" y="44" width="6" height="12" fill="#c4c4c4"/>
        <rect x="48" y="28" width="12" height="4" fill="#c4c4c4"/>
        <rect x="56" y="24" width="6" height="4" fill="#d8d8d8"/>
      </svg>`,
      
      steve: `<svg viewBox="0 0 64 64" xmlns="http://www.w3.org/2000/svg">
        <rect x="16" y="4" width="32" height="32" fill="#c69c6d"/>
        <rect x="16" y="4" width="32" height="12" fill="#4a3728"/>
        <rect x="16" y="16" width="4" height="8" fill="#4a3728"/>
        <rect x="44" y="16" width="4" height="8" fill="#4a3728"/>
        <rect x="22" y="18" width="6" height="6" fill="#fff"/>
        <rect x="24" y="20" width="4" height="4" fill="#4a3728"/>
        <rect x="36" y="18" width="6" height="6" fill="#fff"/>
        <rect x="36" y="20" width="4" height="4" fill="#4a3728"/>
        <rect x="28" y="28" width="8" height="4" fill="#c69c6d"/>
        <rect x="16" y="36" width="32" height="20" fill="#00a8a8"/>
        <rect x="8" y="36" width="8" height="16" fill="#00a8a8"/>
        <rect x="8" y="52" width="8" height="8" fill="#c69c6d"/>
        <rect x="48" y="36" width="8" height="16" fill="#00a8a8"/>
        <rect x="48" y="52" width="8" height="8" fill="#c69c6d"/>
        <rect x="16" y="56" width="14" height="8" fill="#1e1e78"/>
        <rect x="34" y="56" width="14" height="8" fill="#1e1e78"/>
      </svg>`
    };

    // ============ éŠæˆ²ç‹€æ…‹ ============
    let currentUser = null;
    let savedProgress = null;

    let gameState = {
      currentQuestion: 0,
      totalQuestions: 100,
      combo: 0,
      maxCombo: 0,
      cookies: 5,
      lives: 3,
      maxLives: 3,
      xp: 0,
      correct: 0,
      wrong: 0,
      skipped: 0,
      diamonds: 0,
      stars: 0,
      currentWord: "",
      answered: false,
      shuffledWords: [],
      unlockedRewards: [],
      pendingReward: null,
      currentCardType: null
    };

    const rewardMilestones = [
      { questions: 10, type: 'pig', name: 'ğŸ· è±¬è±¬æ”¶è—å¡', icon: 'ğŸ·' },
      { questions: 30, type: 'cow', name: 'ğŸ„ ä¹³ç‰›æ”¶è—å¡', icon: 'ğŸ„' },
      { questions: 60, type: 'creeper', name: 'ğŸ’š è‹¦åŠ›æ€•æ”¶è—å¡', icon: 'ğŸ’š' },
      { questions: 90, type: 'wolf', name: 'ğŸº ç‹¼æ”¶è—å¡', icon: 'ğŸº' },
      { questions: 100, type: 'steve', name: 'â›ï¸ å²å¸å¤«æ”¶è—å¡', icon: 'â›ï¸' }
    ];

    // ============ API å‘¼å«å‡½æ•¸ ============
    async function callAPI(params) {
      const url = new URL(API_URL);
      Object.keys(params).forEach(key => url.searchParams.append(key, params[key]));
      
      try {
        const response = await fetch(url.toString());
        return await response.json();
      } catch (error) {
        console.error('API Error:', error);
        return { success: false, message: 'ç¶²è·¯é€£ç·šéŒ¯èª¤' };
      }
    }

    // ============ ç™»å…¥ç³»çµ± ============
    async function login() {
      const name = document.getElementById('loginName').value.trim();
      const password = document.getElementById('loginPassword').value.trim();
      
      if (!name || !password) {
        showLoginError('è«‹è¼¸å…¥å§“åå’Œå­¸è™Ÿ');
        return;
      }

      showLoginLoading(true);
      hideLoginError();

      const result = await callAPI({
        action: 'login',
        name: name,
        password: password
      });

      showLoginLoading(false);

      if (result.success) {
        currentUser = result.student;
        
        if (result.progress && result.progress.completedQuestions > 0) {
          savedProgress = result.progress;
          showContinuePrompt(result.progress);
        } else {
          startGame();
        }
      } else {
        showLoginError(result.message || 'ç™»å…¥å¤±æ•—');
      }
    }

    function showLoginError(message) {
      const el = document.getElementById('loginError');
      el.textContent = 'âŒ ' + message;
      el.classList.add('show');
    }

    function hideLoginError() {
      document.getElementById('loginError').classList.remove('show');
    }

    function showLoginLoading(show) {
      const el = document.getElementById('loginLoading');
      const btn = document.getElementById('loginBtn');
      if (show) {
        el.classList.add('show');
        btn.disabled = true;
      } else {
        el.classList.remove('show');
        btn.disabled = false;
      }
    }

    function showContinuePrompt(progress) {
      const el = document.getElementById('continuePrompt');
      const info = document.getElementById('continueInfo');
      
      const level = Math.floor(progress.xp / 100) + 1;
      info.innerHTML = `
        å®Œæˆé¡Œæ•¸ï¼š${progress.completedQuestions} é¡Œ<br>
        æ­£ç¢ºç‡ï¼š${progress.accuracy}%<br>
        ç­‰ç´šï¼š${level} | ç¶“é©—å€¼ï¼š${progress.xp}
      `;
      el.style.display = 'block';
    }

    function continueProgress() {
      loadProgressToGame(savedProgress);
      startGame();
    }

    function startNew() {
      savedProgress = null;
      startGame();
    }

    function loadProgressToGame(progress) {
      gameState.correct = progress.correctCount || 0;
      gameState.wrong = progress.wrongCount || 0;
      gameState.xp = progress.xp || 0;
      gameState.cookies = progress.cookies || 5;
      gameState.diamonds = progress.diamonds || 0;
      gameState.stars = progress.stars || 0;
      gameState.maxCombo = progress.maxCombo || 0;
      gameState.currentQuestion = progress.completedQuestions || 0;
      
      // è¼‰å…¥å·²è§£é–çš„çå‹µ
      if (progress.unlockedRewards) {
        gameState.unlockedRewards = progress.unlockedRewards.split(',').filter(r => r);
      }
    }

    function startGame() {
      document.getElementById('continuePrompt').style.display = 'none';
      document.getElementById('loginPanel').classList.remove('active');
      document.getElementById('gamePanel').classList.add('active');
      
      document.getElementById('playerName').textContent = currentUser.name;
      document.getElementById('playerClass').textContent = currentUser.className || 'æœªçŸ¥ç­ç´š';
      
      gameState.shuffledWords = shuffleArray([...wordBank]);
      gameState.totalQuestions = gameState.shuffledWords.length;
      
      createBackgroundBlocks();
      setupAutoSave();
      nextQuestion();

      document.getElementById('answerInput').addEventListener('keypress', function(e) {
        if (e.key === 'Enter') {
          if (gameState.answered) {
            nextQuestion();
          } else {
            submitAnswer();
          }
        }
      });
    }

    // ============ è‡ªå‹•å„²å­˜ ============
    let autoSaveInterval;
    
    function setupAutoSave() {
      // æ¯ 30 ç§’è‡ªå‹•å„²å­˜
      autoSaveInterval = setInterval(() => {
        saveProgress(true);
      }, 30000);
      
      // é é¢é—œé–‰å‰å„²å­˜
      window.addEventListener('beforeunload', () => {
        saveProgress(false);
      });
    }

    async function saveProgress(showIndicator = false) {
      if (!currentUser) return;
      
      if (showIndicator) {
        showAutoSaveIndicator();
      }

      const total = gameState.correct + gameState.wrong;
      const accuracy = total > 0 ? Math.round((gameState.correct / total) * 100) : 0;
      const level = Math.floor(gameState.xp / 100) + 1;

      await callAPI({
        action: 'save',
        studentId: currentUser.studentId,
        name: currentUser.name,
        completedQuestions: gameState.currentQuestion,
        correctCount: gameState.correct,
        wrongCount: gameState.wrong,
        accuracy: accuracy,
        level: level,
        cookies: gameState.cookies,
        diamonds: gameState.diamonds,
        stars: gameState.stars,
        maxCombo: gameState.maxCombo,
        xp: gameState.xp,
        unlockedRewards: gameState.unlockedRewards.join(',')
      });
    }

    function showAutoSaveIndicator() {
      const el = document.getElementById('autoSaveIndicator');
      el.classList.add('show');
      setTimeout(() => el.classList.remove('show'), 1500);
    }

    async function manualSave() {
      showToast('ğŸ’¾ å„²å­˜ä¸­...');
      await saveProgress(false);
      showToast('âœ… å„²å­˜æˆåŠŸï¼');
    }

    function logout() {
      saveProgress(false);
      clearInterval(autoSaveInterval);
      
      currentUser = null;
      savedProgress = null;
      
      // é‡ç½®éŠæˆ²ç‹€æ…‹
      gameState = {
        currentQuestion: 0,
        totalQuestions: 100,
        combo: 0,
        maxCombo: 0,
        cookies: 5,
        lives: 3,
        maxLives: 3,
        xp: 0,
        correct: 0,
        wrong: 0,
        skipped: 0,
        diamonds: 0,
        stars: 0,
        currentWord: "",
        answered: false,
        shuffledWords: [],
        unlockedRewards: [],
        pendingReward: null,
        currentCardType: null
      };
      
      document.getElementById('gamePanel').classList.remove('active');
      document.getElementById('gameOverPanel').classList.remove('active');
      document.getElementById('loginPanel').classList.add('active');
      document.getElementById('loginName').value = '';
      document.getElementById('loginPassword').value = '';
    }

    // ============ éŠæˆ²æ ¸å¿ƒé‚è¼¯ ============
    function shuffleArray(array) {
      for (let i = array.length - 1; i > 0; i--) {
        const j = Math.floor(Math.random() * (i + 1));
        [array[i], array[j]] = [array[j], array[i]];
      }
      return array;
    }

    function createBackgroundBlocks() {
      const container = document.getElementById('bgBlocks');
      container.innerHTML = '';
      const types = ['dirt', 'stone', 'grass'];
      for (let i = 0; i < 12; i++) {
        const block = document.createElement('div');
        block.className = `floating-block ${types[Math.floor(Math.random() * types.length)]}`;
        block.style.left = `${Math.random() * 100}%`;
        block.style.top = `${Math.random() * 100}%`;
        block.style.animationDelay = `${Math.random() * 5}s`;
        container.appendChild(block);
      }
    }

    function nextQuestion() {
      if (gameState.pendingReward) {
        showRewardCard(gameState.pendingReward, true);
        gameState.pendingReward = null;
        return;
      }

      if (gameState.currentQuestion >= gameState.totalQuestions) {
        endGame();
        return;
      }

      gameState.currentWord = gameState.shuffledWords[gameState.currentQuestion];
      gameState.currentQuestion++;
      gameState.answered = false;

      const input = document.getElementById('answerInput');
      input.value = '';
      input.className = 'mc-input';
      input.disabled = false;
      input.focus();

      document.getElementById('submitBtn').style.display = 'inline-block';
      document.getElementById('nextBtn').classList.remove('visible');

      updateDisplay();
      document.getElementById('questionWord').textContent = gameState.currentWord;
    }

    function submitAnswer() {
      if (gameState.answered) return;

      const input = document.getElementById('answerInput');
      const answer = input.value.trim();
      if (!answer) return;

      if (answer === gameState.currentWord) {
        gameState.correct++;
        gameState.combo++;
        gameState.stars++;
        if (gameState.combo > gameState.maxCombo) gameState.maxCombo = gameState.combo;

        const xpGain = 10 + Math.min(gameState.combo, 10) * 2;
        gameState.xp += xpGain;

        if (gameState.correct % 5 === 0) {
          gameState.cookies++;
          showToast('ğŸª ç²å¾—é¤…ä¹¾ï¼');
        }
        if (gameState.correct % 10 === 0) {
          gameState.diamonds++;
        }

        input.className = 'mc-input correct';
        gameState.answered = true;
        document.getElementById('submitBtn').style.display = 'none';
        document.getElementById('nextBtn').classList.add('visible');
        input.disabled = true;
        createParticles('âœ“', '#55FF55');

        checkAndTriggerReward();

      } else {
        gameState.wrong++;
        gameState.combo = 0;
        gameState.lives--;
        
        input.className = 'mc-input wrong';
        createParticles('âœ—', '#FF5555');
        
        updateHeartsWithAnimation();

        if (gameState.lives <= 0) {
          setTimeout(() => endGame(), 800);
          return;
        }

        setTimeout(() => {
          input.className = 'mc-input';
          input.value = '';
          input.focus();
        }, 500);
      }

      updateDisplay();
    }

    function checkAndTriggerReward() {
      const correctCount = gameState.correct;
      
      for (const reward of rewardMilestones) {
        if (correctCount === reward.questions && !gameState.unlockedRewards.includes(reward.type)) {
          gameState.unlockedRewards.push(reward.type);
          gameState.pendingReward = reward.type;
          createFireworks();
          break;
        }
      }
    }

    function createFireworks() {
      const emojis = ['ğŸ‰', 'ğŸŠ', 'âœ¨', 'â­', 'ğŸŒŸ', 'ğŸ’«'];
      for (let i = 0; i < 15; i++) {
        setTimeout(() => {
          const firework = document.createElement('div');
          firework.className = 'firework';
          firework.textContent = emojis[Math.floor(Math.random() * emojis.length)];
          firework.style.left = `${20 + Math.random() * 60}%`;
          firework.style.top = `${20 + Math.random() * 60}%`;
          document.body.appendChild(firework);
          setTimeout(() => firework.remove(), 1500);
        }, i * 100);
      }
    }

    function updateHeartsWithAnimation() {
      const container = document.getElementById('hearts');
      const hearts = container.querySelectorAll('.heart');
      
      const heartIndex = gameState.lives;
      if (hearts[heartIndex]) {
        hearts[heartIndex].classList.add('losing');
        setTimeout(() => {
          hearts[heartIndex].classList.remove('losing');
          hearts[heartIndex].classList.add('empty');
        }, 500);
      }
    }

    function updateDisplay() {
      const level = Math.floor(gameState.xp / 100) + 1;
      document.getElementById('level').textContent = level;
      document.getElementById('combo').textContent = gameState.combo;
      document.getElementById('cookies').textContent = gameState.cookies;
      document.getElementById('diamonds').textContent = gameState.diamonds;
      document.getElementById('stars').textContent = gameState.stars;
      document.getElementById('xpText').textContent = gameState.xp;
      document.getElementById('questionNum').textContent = gameState.currentQuestion;
      document.getElementById('totalQuestions').textContent = gameState.totalQuestions;
      document.getElementById('correctCount').textContent = gameState.correct;
      document.getElementById('correctDisplay').textContent = gameState.correct;
      document.getElementById('wrongCount').textContent = gameState.wrong;
      document.getElementById('skippedCount').textContent = gameState.skipped;

      document.getElementById('xpBar').style.width = `${gameState.xp % 100}%`;

      const total = gameState.correct + gameState.wrong;
      const accuracy = total > 0 ? Math.round((gameState.correct / total) * 100) : 0;
      document.getElementById('accuracy').textContent = `${accuracy}%`;

      updateMilestoneProgress();
      updateHearts();
      updateRewardPreview();

      const comboDisplay = document.getElementById('comboDisplay');
      if (gameState.combo >= 2) {
        comboDisplay.textContent = `ğŸ”¥ ${gameState.combo}`;
        comboDisplay.classList.add('active');
      } else {
        comboDisplay.classList.remove('active');
      }
    }

    function updateMilestoneProgress() {
      const correctCount = gameState.correct;
      let nextMilestone = null;
      let prevMilestone = 0;

      for (const reward of rewardMilestones) {
        if (correctCount < reward.questions) {
          nextMilestone = reward.questions;
          break;
        }
        prevMilestone = reward.questions;
      }

      if (nextMilestone) {
        const progress = ((correctCount - prevMilestone) / (nextMilestone - prevMilestone)) * 100;
        document.getElementById('progressBar').style.width = `${progress}%`;
        document.getElementById('progressText').textContent = `${correctCount} / ${nextMilestone} é¡Œ`;
      } else {
        document.getElementById('progressBar').style.width = '100%';
        document.getElementById('progressText').textContent = 'å…¨éƒ¨å®Œæˆï¼';
      }
    }

    function updateHearts() {
      const container = document.getElementById('hearts');
      container.innerHTML = '';
      for (let i = 0; i < gameState.maxLives; i++) {
        const heart = document.createElement('span');
        heart.className = `heart ${i < gameState.lives ? '' : 'empty'}`;
        heart.textContent = 'â¤ï¸';
        container.appendChild(heart);
      }
    }

    function updateRewardPreview() {
      rewardMilestones.forEach(reward => {
        const el = document.getElementById(`reward${reward.questions}`);
        if (!el) return;
        
        el.classList.remove('unlocked', 'current');
        
        if (gameState.unlockedRewards.includes(reward.type)) {
          el.classList.add('unlocked');
        } else {
          const nextMilestone = rewardMilestones.find(r => !gameState.unlockedRewards.includes(r.type));
          if (nextMilestone && nextMilestone.questions === reward.questions) {
            el.classList.add('current');
          }
        }
      });
    }

    function viewReward(type) {
      if (gameState.unlockedRewards.includes(type)) {
        showRewardCard(type, false);
      } else {
        const reward = rewardMilestones.find(r => r.type === type);
        showToast(`âŒ éœ€è¦ç­”å° ${reward.questions} é¡Œæ‰èƒ½è§£é–ï¼`);
      }
    }

    function showRewardCard(type, isNew = false) {
      const reward = rewardMilestones.find(r => r.type === type);
      gameState.currentCardType = type;
      
      document.getElementById('unlockCelebration').style.display = isNew ? 'block' : 'none';
      document.getElementById('cardTitle').textContent = reward.name;
      document.getElementById('characterDisplay').innerHTML = characterSVG[type];
      document.getElementById('cardPlayerName').textContent = currentUser ? currentUser.name : 'åŒ¿åç¤¦å·¥';
      
      document.getElementById('cardQuestions').textContent = gameState.correct;
      const total = gameState.correct + gameState.wrong;
      const accuracy = total > 0 ? Math.round((gameState.correct / total) * 100) : 0;
      document.getElementById('cardAccuracy').textContent = `${accuracy}%`;
      document.getElementById('cardCombo').textContent = gameState.maxCombo;
      document.getElementById('cardXP').textContent = gameState.xp;
      
      const now = new Date();
      document.getElementById('cardDate').textContent = `${now.getFullYear()}/${now.getMonth()+1}/${now.getDate()}`;
      
      updateMilestoneThumbs(type);
      
      document.getElementById('rewardCardPanel').classList.add('active');
    }

    function updateMilestoneThumbs(activeType) {
      const thumbs = document.querySelectorAll('.milestone-thumb');
      thumbs.forEach(thumb => {
        const type = thumb.dataset.type;
        thumb.classList.remove('unlocked', 'active');
        
        if (gameState.unlockedRewards.includes(type)) {
          thumb.classList.add('unlocked');
        }
        if (type === activeType) {
          thumb.classList.add('active');
        }
      });
    }

    function switchCardType(type) {
      if (gameState.unlockedRewards.includes(type)) {
        showRewardCard(type, false);
      } else {
        const reward = rewardMilestones.find(r => r.type === type);
        showToast(`ğŸ”’ éœ€è¦ç­”å° ${reward.questions} é¡Œè§£é–`);
      }
    }

    function closeRewardCard() {
      document.getElementById('rewardCardPanel').classList.remove('active');
      
      if (gameState.currentQuestion < gameState.totalQuestions && gameState.lives > 0) {
        const input = document.getElementById('answerInput');
        input.focus();
      }
    }

    async function downloadCard() {
      const playerName = currentUser ? currentUser.name : 'åŒ¿åç¤¦å·¥';
      const card = document.getElementById('rewardCard');
      
      try {
        showToast('ğŸ“¸ æ­£åœ¨ç”Ÿæˆåœ–ç‰‡...');
        
        const canvas = await html2canvas(card, {
          backgroundColor: '#1a3009',
          scale: 2,
          useCORS: true,
          logging: false
        });

        const link = document.createElement('a');
        const rewardName = gameState.currentCardType || 'reward';
        link.download = `minecraft-${rewardName}-${playerName}-${Date.now()}.png`;
        link.href = canvas.toDataURL('image/png');
        link.click();

        showToast('âœ… åœ–ç‰‡å·²å„²å­˜ï¼');
      } catch (error) {
        console.error('Download error:', error);
        showToast('âŒ å„²å­˜å¤±æ•—ï¼Œè«‹é‡è©¦');
      }
    }

    async function endGame() {
      await saveProgress(false);
      
      document.getElementById('gamePanel').classList.remove('active');
      document.getElementById('gameOverPanel').classList.add('active');

      const resultTitle = document.getElementById('resultTitle');
      if (gameState.lives <= 0) {
        resultTitle.textContent = 'ğŸ’€ éŠæˆ²çµæŸ';
        resultTitle.classList.add('fail');
      } else {
        resultTitle.textContent = 'ğŸ‰ æŒ–ç¤¦å®Œæˆï¼';
        resultTitle.classList.remove('fail');
      }

      document.getElementById('finalQuestions').textContent = gameState.correct;
      document.getElementById('finalCombo').textContent = gameState.maxCombo;
      document.getElementById('finalXP').textContent = gameState.xp;

      const total = gameState.correct + gameState.wrong;
      const accuracy = total > 0 ? Math.round((gameState.correct / total) * 100) : 0;
      document.getElementById('finalAccuracy').textContent = `${accuracy}%`;

      if (gameState.unlockedRewards.length > 0) {
        document.getElementById('unlockedRewards').style.display = 'block';
        const buttonsContainer = document.getElementById('rewardButtons');
        buttonsContainer.innerHTML = '';

        gameState.unlockedRewards.forEach(type => {
          const reward = rewardMilestones.find(r => r.type === type);
          const btn = document.createElement('button');
          btn.className = 'mc-btn primary';
          btn.innerHTML = `${reward.icon} æŸ¥çœ‹`;
          btn.onclick = () => showRewardCard(type, false);
          buttonsContainer.appendChild(btn);
        });
      } else {
        document.getElementById('unlockedRewards').style.display = 'none';
      }
    }

    function openShop() {
      document.getElementById('shopCookies').textContent = gameState.cookies;
      document.getElementById('shopPanel').classList.add('active');
    }

    function closeShop() {
      document.getElementById('shopPanel').classList.remove('active');
    }

    function useSkip() {
      if (gameState.cookies < 3) {
        showToast('âŒ é¤…ä¹¾ä¸è¶³ï¼');
        return;
      }

      gameState.cookies -= 3;
      gameState.skipped++;
      gameState.combo = 0;
      closeShop();
      
      gameState.answered = true;
      document.getElementById('submitBtn').style.display = 'none';
      document.getElementById('nextBtn').classList.add('visible');
      document.getElementById('answerInput').disabled = true;
      
      updateDisplay();
      showToast('â­ï¸ å·²è·³éæ­¤é¡Œ');
    }

    function restartGame() {
      gameState = {
        currentQuestion: 0,
        totalQuestions: 100,
        combo: 0,
        maxCombo: 0,
        cookies: 5,
        lives: 3,
        maxLives: 3,
        xp: 0,
        correct: 0,
        wrong: 0,
        skipped: 0,
        diamonds: 0,
        stars: 0,
        currentWord: "",
        answered: false,
        shuffledWords: [],
        unlockedRewards: [],
        pendingReward: null,
        currentCardType: null
      };

      gameState.shuffledWords = shuffleArray([...wordBank]);
      gameState.totalQuestions = gameState.shuffledWords.length;

      document.getElementById('gamePanel').classList.add('active');
      document.getElementById('gameOverPanel').classList.remove('active');
      document.getElementById('unlockedRewards').style.display = 'none';
      
      nextQuestion();
    }

    function createParticles(symbol, color) {
      for (let i = 0; i < 5; i++) {
        const particle = document.createElement('div');
        particle.className = 'particle';
        particle.textContent = symbol;
        particle.style.color = color;
        particle.style.left = `${45 + Math.random() * 10}%`;
        particle.style.top = `${35 + Math.random() * 10}%`;
        document.body.appendChild(particle);
        setTimeout(() => particle.remove(), 1000);
      }
    }

    function showToast(message) {
      const existing = document.querySelector('.toast');
      if (existing) existing.remove();

      const toast = document.createElement('div');
      toast.className = 'toast';
      toast.textContent = message;
      document.body.appendChild(toast);
      setTimeout(() => toast.remove(), 2500);
    }

    function toggleFullscreen() {
      if (!document.fullscreenElement) {
        document.documentElement.requestFullscreen();
      } else {
        document.exitFullscreen();
      }
    }

    // åˆå§‹åŒ–èƒŒæ™¯
    createBackgroundBlocks();
    
    // ç™»å…¥è¼¸å…¥æ¡† Enter éµ
    document.getElementById('loginPassword').addEventListener('keypress', function(e) {
      if (e.key === 'Enter') login();
    });
  </script>
</body>
</html>
