<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>èª²å¾Œç…§é¡§é›†åˆå›å ±ç³»çµ±</title>
    <style>
        /* å…¨åŸŸè¨­å®šï¼šå›ºå®šä¸€é ï¼Œç¦æ­¢æ²å‹• */
        body {
            font-family: "Microsoft JhengHei", "Heiti TC", sans-serif;
            background-color: #1a1a2e; /* æ·±è—é»‘è‰²èƒŒæ™¯ */
            color: #ffffff;
            margin: 0;
            padding: 10px; /* ç¸®å°é‚Šè· */
            box-sizing: border-box;
            height: 100vh; /* å¼·åˆ¶èˆ‡è¢å¹•ç­‰é«˜ */
            overflow: hidden; /* ç¦æ­¢å‡ºç¾å·è»¸ */
            display: flex;
            flex-direction: column;
        }

        /* æ¨™é¡Œå€ï¼šç›¡é‡ç¸®å°ä»¥ç•™ç©ºé–“çµ¦æŒ‰éˆ• */
        header {
            flex: 0 0 auto; /* é«˜åº¦è‡ªå‹•ï¼Œä¸ä¼¸ç¸® */
            text-align: center;
            margin-bottom: 10px;
        }

        h1 {
            margin: 0;
            font-size: 1.5rem; /* å­—é«”ç¨å¾®ç¸®å° */
            font-weight: bold;
            color: #ffffff;
        }

        /* ç‹€æ…‹åˆ— */
        .status-bar {
            font-size: 0.9rem;
            color: #a4b0be;
            margin-top: 5px;
        }

        /* æ ¼ç‹€å®¹å™¨ï¼šä½”æ“šæ‰€æœ‰å‰©é¤˜ç©ºé–“ */
        .grid-container {
            flex: 1 1 auto; /* è‡ªå‹•å¡«æ»¿å‰©é¤˜é«˜åº¦ */
            display: grid;
            /* æ‰‹æ©Ÿç‰ˆï¼š3æ¬„ | é›»è…¦ç‰ˆï¼šè‡ªå‹•èª¿æ•´ */
            grid-template-columns: repeat(3, 1fr); 
            grid-gap: 10px; /* æŒ‰éˆ•é–“è· */
            width: 100%;
            max-width: 800px;
            margin: 0 auto;
            /* è®“ grid å……æ»¿é«˜åº¦ */
            align-content: stretch; 
        }

        /* ç•¶è¢å¹•è¼ƒå¯¬æ™‚ (å¹³æ¿/é›»è…¦)ï¼Œæ”¹æˆ 4 æ¬„æˆ–æ›´å¤šï¼Œé¿å…æŒ‰éˆ•å¤ªæ‰ */
        @media (min-width: 600px) {
            .grid-container {
                grid-template-columns: repeat(4, 1fr);
            }
        }

        /* ç­ç´šå¡ç‰‡ï¼šè‡ªå‹•ä¼¸ç¸® */
        .class-card {
            background-color: #3e4152; /* æœªåˆ°é”ï¼šæ·±ç°è‰² */
            color: #e0e0e0;
            border: 2px solid #555;
            border-radius: 8px;
            
            /* è®“æ–‡å­—çµ•å°ç½®ä¸­ */
            display: flex;
            justify-content: center;
            align-items: center;
            
            font-size: 1.5rem; /* å­—é«”å¤§å° */
            font-weight: bold;
            cursor: pointer;
            user-select: none; /* é˜²æ­¢é¸å–æ–‡å­— */
            transition: transform 0.1s, background-color 0.2s;
            box-shadow: 0 4px 6px rgba(0,0,0,0.4);
            
            /* è§¸æ§å„ªåŒ– */
            touch-action: manipulation;
        }

        /* åˆ°é”ç‹€æ…‹ (Arrived)ï¼šå¯¦å¿ƒç¶ è‰² */
        .class-card.arrived {
            background-color: #00b894; 
            color: #ffffff;
            border-color: #00cec9;
            box-shadow: 0 0 15px rgba(0, 184, 148, 0.4);
        }

        /* è™•ç†ä¸­ç‹€æ…‹ */
        .class-card.processing {
            opacity: 0.7;
            background-color: #636e72;
            cursor: wait;
        }

        /* æ»‘é¼ æ‡¸åœ (åƒ…é›»è…¦ç‰ˆ) */
        @media (hover: hover) {
            .class-card:hover {
                background-color: #4e5266;
                transform: translateY(-2px);
            }
            .class-card.arrived:hover {
                background-color: #00b894;
            }
        }

        .class-card:active {
            transform: scale(0.96);
        }

    </style>
</head>
<body>

    <header>
        <h1>é›†åˆå›å ±ç³»çµ±</h1>
        <div class="status-bar">
            ç³»çµ±ç‹€æ…‹ï¼š<span id="connection-status" style="color: #ffeaa7;">é€£ç·šä¸­...</span>
        </div>
    </header>

    <div class="grid-container" id="classGrid">
        </div>

    <script>
        // -----------------------------------------------------------
        // âš ï¸ è«‹å°‡é€™è£¡æ›¿æ›æˆä½ çš„ Google Apps Script éƒ¨ç½²ç¶²å€
        // -----------------------------------------------------------
        const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbwjBcn08HTv11ugu09o3LAGDZA9DKol1_Ny0tYxjRnvvAmNHyIjD0GQ2_RLdmUZHbxs/exec"; 
        // -----------------------------------------------------------

        const classList = [
            "1A", "1B",
            "2A", "2B",
            "3A", "3B",
            "4A", "4B",
            "5A", "5B", "5C",
            "6A", "6B"
        ];

        const gridContainer = document.getElementById('classGrid');
        const statusSpan = document.getElementById('connection-status');
        const pendingUpdates = new Set();

        // 1. åˆå§‹åŒ–ç•«é¢
        function initUI() {
            gridContainer.innerHTML = '';
            classList.forEach(className => {
                const btn = document.createElement('div');
                btn.className = 'class-card';
                btn.id = `btn-${className}`;
                btn.textContent = className;
                
                btn.addEventListener('click', () => {
                    if(!pendingUpdates.has(className)) {
                        toggleStatus(className);
                    }
                });

                gridContainer.appendChild(btn);
            });
            fetchData(); 
        }

        // 2. åˆ‡æ›ç­ç´šç‹€æ…‹ (æ¨‚è§€æ¨¡å¼)
        function toggleStatus(className) {
            const btn = document.getElementById(`btn-${className}`);
            const isCurrentlyArrived = btn.classList.contains('arrived');
            const newStatusIsArrived = !isCurrentlyArrived;

            if (newStatusIsArrived) {
                btn.classList.add('arrived');
            } else {
                btn.classList.remove('arrived');
            }

            pendingUpdates.add(className);
            btn.classList.add('processing');

            fetch(`${SCRIPT_URL}?action=update&class=${className}`)
                .then(response => response.json())
                .then(data => {
                    pendingUpdates.delete(className);
                    btn.classList.remove('processing');
                })
                .catch(err => {
                    console.error("æ›´æ–°å¤±æ•—", err);
                    if (isCurrentlyArrived) {
                        btn.classList.add('arrived');
                    } else {
                        btn.classList.remove('arrived');
                    }
                    pendingUpdates.delete(className);
                    btn.classList.remove('processing');
                    alert("é€£ç·šå¤±æ•—ï¼Œè«‹é‡è©¦");
                });
        }

        // 3. è®€å–è³‡æ–™
        function fetchData() {
            fetch(`${SCRIPT_URL}?action=read`)
                .then(response => response.json())
                .then(data => {
                    updateGrid(data);
                    statusSpan.textContent = "ğŸŸ¢ ç·šä¸ŠåŒæ­¥ä¸­";
                    statusSpan.style.color = "#55efc4"; 
                })
                .catch(err => {
                    statusSpan.textContent = "ğŸ”´ é€£ç·šä¸­æ–·";
                    statusSpan.style.color = "#ff7675"; 
                });
        }

        // 4. æ›´æ–° Grid
        function updateGrid(data) {
            classList.forEach(className => {
                if (pendingUpdates.has(className)) return; 

                const btn = document.getElementById(`btn-${className}`);
                if (data[className] === true) {
                    btn.classList.add('arrived');
                } else {
                    btn.classList.remove('arrived');
                }
            });
        }

        // å•Ÿå‹• UI
        initUI();

        // 3 ç§’è¼ªè©¢ä¸€æ¬¡è³‡æ–™
        setInterval(fetchData, 3000);

    </script>
</body>
</html>
