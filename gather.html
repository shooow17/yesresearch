<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>èª²å¾Œç…§é¡§é›†åˆå›å ±ç³»çµ±</title>
    <style>
        /* å…¨åŸŸè¨­å®š */
        body {
            font-family: "Microsoft JhengHei", "Heiti TC", sans-serif;
            background-color: #1a1a2e;
            color: #ffffff;
            margin: 0;
            padding: 10px;
            box-sizing: border-box;
            
            /* --- é—œéµä¿®æ­£é–‹å§‹ --- */
            /* ä½¿ç”¨ dvh (Dynamic Viewport Height) è‡ªå‹•æ‰£é™¤ç€è¦½å™¨å·¥å…·åˆ—é«˜åº¦ */
            height: 100vh; /* èˆŠç€è¦½å™¨å‚™æ¡ˆ */
            height: 100dvh; /* æ–°ç€è¦½å™¨å°ˆç”¨ */
            
            overflow: hidden; /* ä¿æŒç¦æ­¢å·è»¸ */
            /* --- é—œéµä¿®æ­£çµæŸ --- */

            display: flex;
            flex-direction: column;
        }

        header {
            flex: 0 0 auto;
            text-align: center;
            margin-bottom: 5px; /* ç¸®å°æ¨™é¡Œä¸‹æ–¹çš„ç•™ç™½ */
        }

        h1 {
            margin: 0;
            font-size: 1.4rem; /* æ¨™é¡Œå­—å†ç¸®å°ä¸€é»ï¼Œç•™ç©ºé–“çµ¦æŒ‰éˆ• */
            font-weight: bold;
            color: #ffffff;
        }

        .status-bar {
            font-size: 0.85rem;
            color: #a4b0be;
            margin-top: 3px;
        }

        .grid-container {
            flex: 1 1 auto; /* è‡ªå‹•å¡«æ»¿å‰©é¤˜ç©ºé–“ */
            display: grid;
            grid-template-columns: repeat(3, 1fr); 
            grid-gap: 8px; /* æŒ‰éˆ•é–“è·ç¨å¾®ç¸®å° */
            width: 100%;
            max-width: 800px;
            margin: 0 auto;
            align-content: stretch; 
            
            /* --- é—œéµä¿®æ­£ï¼šåº•éƒ¨ç•™ç™½ --- */
            /* é ç•™åº•éƒ¨ç©ºé–“ï¼Œé˜²æ­¢è²¼åº•è¢«æ“‹ä½ */
            padding-bottom: 10px; 
            /* é‡å° iPhone X ä»¥ä¸Šçš„åº•éƒ¨æ©«æ¢ (Home Indicator) å¢åŠ å®‰å…¨è·é›¢ */
            padding-bottom: calc(10px + env(safe-area-inset-bottom));
        }

        @media (min-width: 600px) {
            .grid-container {
                grid-template-columns: repeat(4, 1fr);
                padding-bottom: 10px; /* é›»è…¦ç‰ˆä¸éœ€è¦å¤ªå¤šåº•éƒ¨ç•™ç™½ */
            }
        }

        .class-card {
            background-color: #3e4152;
            color: #e0e0e0;
            border: 2px solid #555;
            border-radius: 8px;
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 1.5rem;
            font-weight: bold;
            cursor: pointer;
            user-select: none;
            transition: transform 0.1s, background-color 0.2s;
            box-shadow: 0 4px 6px rgba(0,0,0,0.4);
            touch-action: manipulation;
        }

        .class-card.arrived {
            background-color: #00b894; 
            color: #ffffff;
            border-color: #00cec9;
            box-shadow: 0 0 15px rgba(0, 184, 148, 0.4);
        }

        .class-card.processing {
            opacity: 0.7;
            background-color: #636e72;
            cursor: wait;
        }

        @media (hover: hover) {
            .class-card:hover {
                background-color: #4e5266;
                transform: translateY(-2px);
            }
            .class-card.arrived:hover {
                background-color: #00b894;
            }
        }

        .class-card:active {
            transform: scale(0.96);
        }

    </style>
</head>
<body>

    <header>
        <h1>é›†åˆå›å ±ç³»çµ±</h1>
        <div class="status-bar">
            ç³»çµ±ç‹€æ…‹ï¼š<span id="connection-status" style="color: #ffeaa7;">é€£ç·šä¸­...</span>
        </div>
    </header>

    <div class="grid-container" id="classGrid">
        </div>

    <script>
        // -----------------------------------------------------------
        // âš ï¸ è«‹å°‡é€™è£¡æ›¿æ›æˆä½ çš„ Google Apps Script éƒ¨ç½²ç¶²å€
        // -----------------------------------------------------------
        const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbwjBcn08HTv11ugu09o3LAGDZA9DKol1_Ny0tYxjRnvvAmNHyIjD0GQ2_RLdmUZHbxs/exec"; 
        // -----------------------------------------------------------

        const classList = [
            "1A", "1B",
            "2A", "2B",
            "3A", "3B",
            "4A", "4B",
            "5A", "5B", "5C",
            "6A", "6B"
        ];

        const gridContainer = document.getElementById('classGrid');
        const statusSpan = document.getElementById('connection-status');
        const pendingUpdates = new Set();

        function initUI() {
            gridContainer.innerHTML = '';
            classList.forEach(className => {
                const btn = document.createElement('div');
                btn.className = 'class-card';
                btn.id = `btn-${className}`;
                btn.textContent = className;
                btn.addEventListener('click', () => {
                    if(!pendingUpdates.has(className)) {
                        toggleStatus(className);
                    }
                });
                gridContainer.appendChild(btn);
            });
            fetchData(); 
        }

        function toggleStatus(className) {
            const btn = document.getElementById(`btn-${className}`);
            const isCurrentlyArrived = btn.classList.contains('arrived');
            const newStatusIsArrived = !isCurrentlyArrived;

            if (newStatusIsArrived) {
                btn.classList.add('arrived');
            } else {
                btn.classList.remove('arrived');
            }

            pendingUpdates.add(className);
            btn.classList.add('processing');

            fetch(`${SCRIPT_URL}?action=update&class=${className}`)
                .then(response => response.json())
                .then(data => {
                    pendingUpdates.delete(className);
                    btn.classList.remove('processing');
                })
                .catch(err => {
                    console.error("æ›´æ–°å¤±æ•—", err);
                    if (isCurrentlyArrived) {
                        btn.classList.add('arrived');
                    } else {
                        btn.classList.remove('arrived');
                    }
                    pendingUpdates.delete(className);
                    btn.classList.remove('processing');
                    alert("é€£ç·šå¤±æ•—ï¼Œè«‹é‡è©¦");
                });
        }

        function fetchData() {
            fetch(`${SCRIPT_URL}?action=read`)
                .then(response => response.json())
                .then(data => {
                    updateGrid(data);
                    statusSpan.textContent = "ğŸŸ¢ ç·šä¸ŠåŒæ­¥ä¸­";
                    statusSpan.style.color = "#55efc4"; 
                })
                .catch(err => {
                    statusSpan.textContent = "ğŸ”´ é€£ç·šä¸­æ–·";
                    statusSpan.style.color = "#ff7675"; 
                });
        }

        function updateGrid(data) {
            classList.forEach(className => {
                if (pendingUpdates.has(className)) return; 
                const btn = document.getElementById(`btn-${className}`);
                if (data[className] === true) {
                    btn.classList.add('arrived');
                } else {
                    btn.classList.remove('arrived');
                }
            });
        }

        initUI();
        setInterval(fetchData, 3000);

    </script>
</body>
</html>
