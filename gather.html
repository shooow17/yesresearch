<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>èª²å¾Œç…§é¡§ - ç­ç´šé›†åˆæˆ°æƒ…ä¸­å¿ƒ</title>
    <link href="https://fonts.googleapis.com/css2?family=Rajdhani:wght@500;700&display=swap" rel="stylesheet">
    <style>
        /* å…¨åŸŸè¨­å®šï¼šæ·±è‰²èƒŒæ™¯èˆ‡ç§‘æŠ€æ„Ÿå­—é«” */
        body {
            font-family: 'Rajdhani', 'Microsoft JhengHei', sans-serif;
            background: linear-gradient(135deg, #0d1117 0%, #161b22 100%); /* æ·±è‰²æ¼¸å±¤èƒŒæ™¯ */
            color: #00fff2; /* é è¨­é’è‰²æ–‡å­— */
            margin: 0;
            padding: 20px;
            display: flex;
            flex-direction: column;
            align-items: center;
            min-height: 100vh;
            /* èƒŒæ™¯ç¶²æ ¼ç·šæ•ˆæœ */
            background-image: 
                linear-gradient(rgba(0, 255, 242, 0.05) 1px, transparent 1px),
                linear-gradient(90deg, rgba(0, 255, 242, 0.05) 1px, transparent 1px);
            background-size: 30px 30px;
        }

        h1 {
            margin-bottom: 15px;
            text-align: center;
            font-weight: 700;
            letter-spacing: 2px;
            text-transform: uppercase;
            /* æ–‡å­—éœ“è™¹ç™¼å…‰æ•ˆæœ */
            text-shadow: 0 0 10px rgba(0, 255, 242, 0.7), 0 0 20px rgba(0, 255, 242, 0.5);
        }

        /* ç‹€æ…‹åˆ—ï¼šåŠé€æ˜ç»ç’ƒè³ªæ„Ÿ */
        .status-bar {
            background: rgba(13, 17, 23, 0.8); /* åŠé€æ˜æ·±è‰² */
            border: 1px solid rgba(0, 255, 242, 0.3);
            padding: 12px 25px;
            border-radius: 4px;
            box-shadow: 0 0 15px rgba(0, 255, 242, 0.1) inset;
            margin-bottom: 30px;
            text-align: center;
            font-size: 1.1rem;
            backdrop-filter: blur(5px); /* æ¯›ç»ç’ƒæ•ˆæœ */
        }

        .grid-container {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(110px, 1fr));
            gap: 20px;
            width: 100%;
            max-width: 900px;
        }

        /* ç­ç´šå¡ç‰‡ï¼šæ ¸å¿ƒç§‘æŠ€æ„Ÿè¨­è¨ˆ */
        .class-card {
            /* é è¨­ç‹€æ…‹ï¼šæœªåˆ°é” (æš—é’è‰²) */
            background: rgba(22, 27, 34, 0.8);
            color: rgba(0, 255, 242, 0.6); /*ç¨å¾®æš—ä¸€é»çš„æ–‡å­—*/
            border: 2px solid rgba(0, 255, 242, 0.3); /* å¾®å…‰é‚Šæ¡† */
            border-radius: 8px;
            padding: 25px 10px;
            text-align: center;
            font-size: 1.8rem;
            font-weight: 700;
            cursor: pointer;
            transition: all 0.3s cubic-bezier(0.25, 0.8, 0.25, 1); /* æ›´æœ‰å½ˆæ€§çš„éæ¸¡ */
            user-select: none;
            position: relative;
            overflow: hidden;
            letter-spacing: 1px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.3);
        }

        /* æ»‘é¼ æ‡¸åœæ•ˆæœ */
        .class-card:hover {
            border-color: rgba(0, 255, 242, 0.8);
            box-shadow: 0 0 20px rgba(0, 255, 242, 0.4);
            color: rgba(0, 255, 242, 1);
            transform: translateY(-2px);
        }

        .class-card:active { transform: scale(0.97); }

        /* --- åˆ°é”ç‹€æ…‹ (Arrived)ï¼šå¼·çƒˆè¢å…‰ç¶  --- */
        .class-card.arrived {
            background: rgba(46, 204, 113, 0.15); /* æ·¡æ·¡çš„ç¶ è‰²èƒŒæ™¯ */
            color: #39ff14; /* è¢å…‰ç¶ æ–‡å­— */
            border-color: #39ff14; /* è¢å…‰ç¶ é‚Šæ¡† */
            /* å¼·çƒˆçš„ç¶ è‰²ç™¼å…‰ç‰¹æ•ˆ */
            box-shadow: 
                0 0 10px rgba(57, 255, 20, 0.6), 
                0 0 30px rgba(57, 255, 20, 0.4) inset;
            text-shadow: 0 0 10px rgba(57, 255, 20, 0.8);
        }

        /* --- è™•ç†ä¸­ç‹€æ…‹ (Processing)ï¼šè„ˆè¡å‹•ç•« --- */
        .class-card.processing {
            cursor: wait;
            animation: pulse-cyan 1.5s infinite ease-in-out;
        }

        /* å®šç¾©è„ˆè¡å‹•ç•« */
        @keyframes pulse-cyan {
            0% { box-shadow: 0 0 5px rgba(0, 255, 242, 0.3); opacity: 1; }
            50% { box-shadow: 0 0 25px rgba(0, 255, 242, 0.6); opacity: 0.7; }
            100% { box-shadow: 0 0 5px rgba(0, 255, 242, 0.3); opacity: 1; }
        }

        /* åº•éƒ¨æ§åˆ¶å€ */
        .controls {
            margin-top: 50px;
            padding-top: 25px;
            border-top: 1px solid rgba(0, 255, 242, 0.2);
            width: 100%;
            max-width: 900px;
            text-align: right;
        }

        /* é‡ç½®æŒ‰éˆ•ï¼šç´…è‰²è­¦æˆ’é¢¨æ ¼ */
        .reset-btn {
            background: transparent;
            color: #ff3860; /* è¢å…‰ç´… */
            border: 2px solid #ff3860;
            padding: 12px 30px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 1.1rem;
            font-family: 'Rajdhani', sans-serif;
            font-weight: 700;
            letter-spacing: 1px;
            transition: all 0.3s ease;
            text-transform: uppercase;
        }

        .reset-btn:hover {
            background: #ff3860;
            color: #161b22;
            box-shadow: 0 0 20px rgba(255, 56, 96, 0.6);
        }
        
    </style>
</head>
<body>

    <h1>ğŸš€ èª²å¾Œç…§é¡§ - ç­ç´šé›†åˆæˆ°æƒ…ä¸­å¿ƒ</h1>
    
    <div class="status-bar">
        ç³»çµ±é€£ç·šç‹€æ…‹ï¼š<span id="connection-status" style="color: #ff3860;">é€£ç·šåˆå§‹åŒ–...</span>
    </div>

    <div class="grid-container" id="classGrid">
        </div>

    <div class="controls">
        <button onclick="resetSystem()" class="reset-btn">âš ï¸ æ‰‹å‹•é‡ç½®ç³»çµ±</button>
    </div>

    <script>
        // -----------------------------------------------------------
        // âš ï¸ è«‹å°‡é€™è£¡æ›¿æ›æˆä½ çš„ Google Apps Script éƒ¨ç½²ç¶²å€
        // -----------------------------------------------------------
        const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbwjBcn08HTv11ugu09o3LAGDZA9DKol1_Ny0tYxjRnvvAmNHyIjD0GQ2_RLdmUZHbxs/exec"; 
        // -----------------------------------------------------------

        const classList = [
            "1A", "1B",
            "2A", "2B",
            "3A", "3B",
            "4A", "4B",
            "5A", "5B", "5C",
            "6A", "6B"
        ];

        const gridContainer = document.getElementById('classGrid');
        const statusSpan = document.getElementById('connection-status');
        const pendingUpdates = new Set();

        // 1. åˆå§‹åŒ–ç•«é¢
        function initUI() {
            gridContainer.innerHTML = '';
            classList.forEach(className => {
                const btn = document.createElement('div');
                btn.className = 'class-card';
                btn.id = `btn-${className}`;
                btn.textContent = className;
                
                btn.addEventListener('click', () => {
                    if(!pendingUpdates.has(className)) {
                        toggleStatus(className);
                    }
                });

                gridContainer.appendChild(btn);
            });
            fetchData(); 
        }

        // 2. åˆ‡æ›ç­ç´šç‹€æ…‹ (æ¨‚è§€æ¨¡å¼)
        function toggleStatus(className) {
            const btn = document.getElementById(`btn-${className}`);
            const isCurrentlyArrived = btn.classList.contains('arrived');
            const newStatusIsArrived = !isCurrentlyArrived;

            if (newStatusIsArrived) {
                btn.classList.add('arrived');
            } else {
                btn.classList.remove('arrived');
            }

            pendingUpdates.add(className);
            btn.classList.add('processing');

            fetch(`${SCRIPT_URL}?action=update&class=${className}`)
                .then(response => response.json())
                .then(data => {
                    pendingUpdates.delete(className);
                    btn.classList.remove('processing');
                })
                .catch(err => {
                    console.error("æ›´æ–°å¤±æ•—", err);
                    if (isCurrentlyArrived) {
                        btn.classList.add('arrived');
                    } else {
                        btn.classList.remove('arrived');
                    }
                    pendingUpdates.delete(className);
                    btn.classList.remove('processing');
                    alert("é€£ç·šå¤±æ•—ï¼Œè«‹é‡è©¦");
                });
        }

        // 3. è®€å–è³‡æ–™
        function fetchData() {
            fetch(`${SCRIPT_URL}?action=read`)
                .then(response => response.json())
                .then(data => {
                    updateGrid(data);
                    statusSpan.textContent = "ğŸŸ¢ ç³»çµ±é‹ä½œä¸­ (SYSTEM ONLINE)";
                    statusSpan.style.color = "#39ff14"; // è¢å…‰ç¶ 
                })
                .catch(err => {
                    statusSpan.textContent = "ğŸ”´ é€£ç·šä¸­æ–· (CONNECTION LOST)";
                    statusSpan.style.color = "#ff3860"; // è¢å…‰ç´…
                });
        }

        // 4. æ›´æ–° Grid
        function updateGrid(data) {
            classList.forEach(className => {
                if (pendingUpdates.has(className)) return; 

                const btn = document.getElementById(`btn-${className}`);
                if (data[className] === true) {
                    btn.classList.add('arrived');
                } else {
                    btn.classList.remove('arrived');
                }
            });
        }

        // 5. æ‰‹å‹•é‡ç½®
        window.resetSystem = function() {
            if(!confirm("ã€è­¦å‘Šã€‘ç¢ºå®šè¦åŸ·è¡Œå…¨ç³»çµ±é‡ç½®å—ï¼Ÿæ‰€æœ‰ç­ç´šç‹€æ…‹å°‡æ­¸é›¶ã€‚")) return;

            statusSpan.textContent = "âš ï¸ ç³»çµ±é‡ç½®åŸ·è¡Œä¸­...";
            statusSpan.style.color = "#ff3860";
            fetch(`${SCRIPT_URL}?action=reset`)
                .then(() => {
                    classList.forEach(cls => {
                            document.getElementById(`btn-${cls}`).classList.remove('arrived');
                    });
                    fetchData();
                })
                .catch(err => alert("é‡ç½®å¤±æ•—"));
        }

        initUI();
        setInterval(fetchData, 3000);

    </script>
</body>
</html>
